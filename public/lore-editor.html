<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Lore - NOXISTENCE</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary: #4a6bff;
      --danger: #ff4a4a;
      --dark: #1a1a2e;
      --light: #f8f9fa;
    }
    body { background: var(--dark); color: var(--light); font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .card { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .form-control { width: 100%; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.1); border: 1px solid #333; color: white; border-radius: 4px; }
    .articles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .article-card { background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden; }
    .article-thumbnail { width: 100%; height: 180px; object-fit: cover; }
    .article-content { padding: 15px; }
    .hidden { display: none; }
    #editor { min-height: 300px; padding: 15px; background: white; color: #333; border-radius: 4px; margin: 10px 0; }
    #preview { padding: 15px; background: rgba(0,0,0,0.2); border-radius: 4px; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Editor de Lore</h1>
    
    <div id="listView">
      <div class="card">
        <input type="text" id="searchInput" class="form-control" placeholder="Buscar artículos...">
      </div>
      
      <button id="newArticleBtn" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nuevo Artículo
      </button>
      
      <div id="articlesContainer" class="articles-grid">
        <div class="empty-state">
          <p>No hay artículos. Crea tu primer artículo para comenzar.</p>
        </div>
      </div>
    </div>
    
    <div id="editView" class="hidden">
      <form id="articleForm" class="card">
        <input type="hidden" id="articleId">
        
        <div class="form-group">
          <label>Título</label>
          <input type="text" id="title" class="form-control" required>
        </div>
        
        <div class="form-group">
          <label>Resumen</label>
          <textarea id="excerpt" class="form-control" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Miniatura</label>
          <input type="file" id="thumbnail" class="form-control" accept="image/*">
          <img id="thumbnailPreview" style="max-width: 200px; margin-top: 10px; display: none;">
        </div>
        
        <div class="form-group">
          <label>Contenido</label>
          <div id="editor" contenteditable="true"></div>
        </div>
        
        <div class="form-group">
          <label>Vista Previa</label>
          <div id="preview"></div>
        </div>
        
        <div>
          <button type="button" id="cancelBtn" class="btn">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Elementos del DOM
    const listView = document.getElementById('listView');
    const editView = document.getElementById('editView');
    const newArticleBtn = document.getElementById('newArticleBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const articleForm = document.getElementById('articleForm');
    const searchInput = document.getElementById('searchInput');
    const articlesContainer = document.getElementById('articlesContainer');
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const thumbnailInput = document.getElementById('thumbnail');
    const thumbnailPreview = document.getElementById('thumbnailPreview');
    
    // Variables de estado
    let articles = [];
    
    // Event Listeners
    newArticleBtn?.addEventListener('click', showNewArticleForm);
    cancelBtn?.addEventListener('click', showArticleList);
    articleForm?.addEventListener('submit', handleFormSubmit);
    searchInput?.addEventListener('input', filterArticles);
    thumbnailInput?.addEventListener('change', handleThumbnailUpload);
    
    // Cargar artículos al iniciar
    loadArticles();
    
    // Funciones
    async function loadArticles() {
      try {
        const response = await fetch('/api/lore');
        const data = await response.json();
        articles = data.articles || [];
        renderArticles(articles);
      } catch (error) {
        console.error('Error al cargar artículos:', error);
        alert('Error al cargar los artículos');
      }
    }
    
    function renderArticles(articlesToRender) {
      if (!articlesToRender.length) {
        articlesContainer.innerHTML = '<p>No se encontraron artículos.</p>';
        return;
      }
      
      articlesContainer.innerHTML = articlesToRender.map(article => {
        const thumbnailHtml = article.thumbnail 
          ? `<img src="${article.thumbnail}" class="article-thumbnail" alt="${article.title}">`
          : '<div class="article-thumbnail" style="background: #333; display: flex; align-items: center; justify-content: center; color: #666;"><i class="fas fa-image" style="font-size: 2rem;"></i></div>';
        
        return `
          <div class="article-card">
            ${thumbnailHtml}
            <div class="article-content">
              <h3>${article.title}</h3>
              <p>${article.excerpt || 'Sin descripción'}</p>
              <button class="btn btn-primary edit-article" data-id="${article.id}">
                <i class="fas fa-edit"></i> Editar
              </button>
              <button class="btn btn-danger delete-article" data-id="${article.id}">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      // Agregar event listeners a los botones
      document.querySelectorAll('.edit-article').forEach(btn => {
        btn.addEventListener('click', () => editArticle(btn.dataset.id));
      });
      
      document.querySelectorAll('.delete-article').forEach(btn => {
        btn.addEventListener('click', () => deleteArticle(btn.dataset.id));
      });
    }
    
    function showNewArticleForm() {
      articleForm.reset();
      document.getElementById('articleId').value = '';
      editor.innerHTML = '';
      preview.innerHTML = '';
      thumbnailPreview.style.display = 'none';
      listView.classList.add('hidden');
      editView.classList.remove('hidden');
    }
    
    function showArticleList() {
      listView.classList.remove('hidden');
      editView.classList.add('hidden');
      loadArticles();
    }
    
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const submitBtn = articleForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
      
      const articleId = document.getElementById('articleId').value;
      const formData = new FormData();
      
      // Agregar campos al formData
      formData.append('title', document.getElementById('title').value);
      formData.append('content', editor.innerHTML);
      formData.append('excerpt', document.getElementById('excerpt').value);
      
      // Agregar la miniatura si existe
      const thumbnailFile = thumbnailInput.files[0];
      if (thumbnailFile) {
        formData.append('thumbnail', thumbnailFile);
      }
      
      try {
        const url = articleId ? `/api/lore/${articleId}` : '/api/lore';
        const method = articleId ? 'PUT' : 'POST';
        
        console.log('Enviando solicitud a:', url);
        const response = await fetch(url, {
          method,
          body: formData,
          // No establecer Content-Type, el navegador lo hará automáticamente con el boundary
        });
        
        console.log('Respuesta recibida, estado:', response.status);
        
        let result;
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('Respuesta no es JSON:', text);
          throw new Error('El servidor devolvió una respuesta no válida');
        }
        
        if (!response.ok) {
          throw new Error(result.error || 'Error al guardar el artículo');
        }
        
        // Mostrar mensaje de éxito
        alert(articleId ? 'Artículo actualizado correctamente' : 'Artículo creado correctamente');
        showArticleList();
      } catch (error) {
        console.error('Error en handleFormSubmit:', error);
        alert(error.message || 'Error al guardar el artículo. Revisa la consola para más detalles.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    }
    
    async function editArticle(id) {
      try {
        const response = await fetch(`/api/lore/${id}`);
        const article = await response.json();
        
        document.getElementById('articleId').value = article.id;
        document.getElementById('title').value = article.title;
        document.getElementById('excerpt').value = article.excerpt || '';
        editor.innerHTML = article.content || '';
        
        if (article.thumbnail) {
          thumbnailPreview.src = article.thumbnail;
          thumbnailPreview.style.display = 'block';
        }
        
        showNewArticleForm();
      } catch (error) {
        console.error('Error al cargar el artículo:', error);
        alert('Error al cargar el artículo');
      }
    }
    
    async function deleteArticle(id) {
      if (!confirm('¿Estás seguro de eliminar este artículo?')) return;
      
      try {
        const response = await fetch(`/api/lore/${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) throw new Error('Error al eliminar el artículo');
        
        loadArticles();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el artículo');
      }
    }
    
    function filterArticles() {
      const searchTerm = searchInput.value.toLowerCase();
      const filtered = articles.filter(article => 
        article.title.toLowerCase().includes(searchTerm) || 
        (article.excerpt && article.excerpt.toLowerCase().includes(searchTerm))
      );
      renderArticles(filtered);
    }
    
    function handleThumbnailUpload(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          thumbnailPreview.src = e.target.result;
          thumbnailPreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Actualizar vista previa cuando se escribe en el editor
    editor?.addEventListener('input', () => {
      preview.innerHTML = editor.innerHTML;
    });
  </script>
</body>
</html>